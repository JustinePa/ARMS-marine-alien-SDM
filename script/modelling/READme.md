# Species Distribution Modeling Scripts

This repository contains R scripts and SLURM job submission files for running species distribution models using the biomod2 framework. 
These scripts were used to model 69 marine invasive species across European waters for "The role of genetic observatory networks in the detection and forecasting of marine non-indigenous species" ([preprint](https://doi.org/10.21203/rs.3.rs-8702791/v1)).

## Overview

The modeling pipeline consists of four main steps:
01. **Individual modeling** - Train multiple algorithms for each species
02. **Ensemble modeling** - Create ensemble models from individual models
03. **Current projections** - Project ensemble models to current conditions
04. **Future projections** - Project to future climate scenarios (SSP 1-2.6, 2-4.5, 5-8.5)

All steps are designed for parallel execution on HPC clusters using SLURM job arrays.

## Scripts

### 1. Individual Species Modeling
This step fits species distribution models for each species independently and saves model evaluation metrics. It is the most computationally intensive step and is designed to run as a SLURM job array on an HPC cluster.
- **01_modeling_mixedPA.R** - Main modeling script with mixed pseudo-absence strategy
- **01_modeling_mixedPA_array.slurm** - SLURM array job for parallel processing

**Algorithms:** Random Forest (RF), MAXNET, MARS, GAM, XGBoost (more can be chosen, see BIOMOD2 documentation  
**Cross-validation:** 5-fold CV  
**Pseudo-absences:** Mixed strategy (disk + random), 20-100 km from presences for the disk method

### Prerequisites

Before running this step, make sure you have:

- [ ] R 4.4.1 with the following packages installed: `biomod2`, `terra`, `dplyr`
- [ ] A working SLURM environment (see note below on cluster compatibility)
- [ ] The environmental raster `myExpl_shelf.tif` in your working directory
      (generated by `pre-modelling/environmental data/` scripts 01–08)
- [ ] Thinned occurrence files for each species in `occurrences_thinned_0825/`,
      named `{SpeciesName}_merged_thinned_2025-08-19.csv`
      (generated by `pre-modelling/occurrence data/` scripts 01–04)
- [ ] `species_list.txt` in your working directory, one species per line

### Setup

Open `01_modeling_mixedPA_array.slurm` and edit the following fields:
```bash
#SBATCH -A                    # your project/allocation ID
#SBATCH --array=1-69          # adjust to match the number of lines in species_list.txt
MODELING_DATE="2025-09-24"    # keep this date for the published analysis,
                              # or set today's date if re-running from scratch
export R_LIBS_USER=           # path to your R library
cd                            # path to your working directory
```

> ⚠️ **Important:** `MODELING_DATE` is used to build the `modeling_id` string
> that links outputs across scripts 01–04. If you change it here, you must
> use the same value in `02_ensemble_array.slurm`, `03_projection_EM.slurm`,
> and `04_projection_future_EM_array.slurm`.

> ⚠️ **Cluster compatibility:** The module load commands are specific to the
> Dardel cluster at PDC (KTH, Sweden). Replace them with the equivalent
> modules available on your system, ensuring R 4.4.1, GDAL, PROJ, and GEOS
> are loaded.

### Run
```bash
sbatch 01_modeling_mixedPA_array.slurm
```

Each array task processes one species. Logs are written to
`logs/{SpeciesName}/{SpeciesName}_{JobID}_{TaskID}.out/.err`.

### Outputs

For each species, the following file is written to `eval/`:
```
eval/{SpeciesName}_mixed_myExpl_shelf_kfold/
└── eval_{SpeciesName}_2025-09-24_mix50_kfold_myExpl_shelf.csv
```

This CSV contains TSS, ROC, and other evaluation metrics for each
algorithm × CV fold combination. These are used in Figure 1 and as
input to Step 2 (ensemble modelling).

### Key modelling choices

| Parameter | Value | Reason |
|---|---|---|
| Algorithms | RF, MAXNET, MARS, GAM, XGBoost | Diverse algorithmic families for ensemble robustness |
| Cross-validation | 5-fold | Balance between computational cost and evaluation reliability |
| Pseudo-absence strategy | Mixed disk + random (50/50) | Reduces spatial bias while maintaining background representation |
| PA distance | 20–100 km from presences | Avoids false absences in areas likely occupied |
| PA count | 3× presences (max 500 for n < 100) | Scales with data availability |

### Troubleshooting

- **Species not found:** Check that the species name in `species_list.txt`
  matches the filename in `occurrences_thinned_0825/` exactly.
- **Fewer than 10 presences:** The script will exit cleanly with an error
  message. These species are excluded from downstream analysis.
- **Job times out:** Increase `--time` in the SLURM script. Runtime scales
  with occurrence count and available cores.


### 2. Ensemble Modeling
- **02_ensemble.R** - Create ensemble models from individual algorithms
- **02_ensemble_array.slurm** - SLURM array job

**Ensemble methods:** EMwmean (weighted mean), EMcv (coefficient of variation), EMca (committee averaging)  
**Selection thresholds:** TSS ≥ 0.6, ROC ≥ 0.85

### 3. Current Projections
- **03_projection_EM.R** - Project ensemble models to current environmental conditions
- **03_projection_EM.slurm** - Single projection job
- **03_projection_EM_array.slurm** - Array job for multiple species

### 4. Future Projections
- **04_projection_EM_future.R** - Project to future climate scenarios
- **04_projection_future_EM_array.slurm** - Array job for all scenarios

## Requirements

### R Packages
```r
install.packages(c("biomod2", "terra", "dplyr", "tidyr", "PRROC"))
```

### HPC Environment
- SLURM workload manager
- R 4.4+ with spatial libraries (GDAL, PROJ, GEOS)
- Sufficient memory (scripts use 4 CPUs, ~16-32 GB RAM per task)

## Input Files

### Required Data
1. **Species list:** `species_list.txt` (all species you wish to model) or `species_list_ensemble.txt` (all species that actually got individual models, as some did not get enough occurrence data to be modelled)
2. **Occurrence data:** `occurrences_thinned_0825/{species}_merged_thinned_2025-08-19.csv`
   - Generated from `pre-modelling/occurrence_data/` pipeline
3. **Environmental layers:** 
   - Current: `myExpl_shelf.tif`
   - Future: `ssp126_shelf_2100.tif`, `ssp245_shelf_2100.tif`, `ssp585_shelf_2100.tif`
   - Generated from `pre-modelling/environmental_data/` pipeline

### Input Format
**Occurrence files** must contain:
- `longitude` - Decimal longitude
- `latitude` - Decimal latitude  
- `occurrenceStatus` - 1 for presence, 0 for absence

## Key Parameters

### Modeling (Script 1)
- **PA distance:** 20-100 km from presences
- **CV strategy:** 5-fold cross-validation
- **Algorithms:** RF, MAXNET, MARS, GAM, XGBOOST
- **Cores:** 4 per species

### Ensemble (Script 2)
- **Metric thresholds:** TSS ≥ 0.6, ROC ≥ 0.85
- **Ensemble algorithms:** EMwmean, EMcv, EMca
- **Model selection:** Based on TSS and ROC performance

### Projections (Scripts 3-4)
- **Extent:** Continental shelf (0-200m depth)
- **Output format:** Binary predictions + habitat suitability (0-1)
- **Uncertainty metrics:** Coefficient of variation, committee averaging

## Output Structure

```
project/
├── eval/                           # Individual model outputs
│   └── {species}_mixed_*/
│       ├── {species}.models.out    # biomod2 model object
│       └── individual_eval.csv     # Model evaluation metrics
│
├── EM_mix50/                       # Ensemble models
│   └── full_eval_EM_{species}.csv  # Ensemble evaluation
│
├── current_proj/                   # Current projections
│   └── {species}/
│       ├── EMwmean/
│       ├── EMcv/
│       └── EMca/
│
├── ssp126_proj/                    # Future projections (low)
├── ssp245_proj/                    # Future projections (medium)
└── ssp585_proj/                    # Future projections (high)
```

## Integration with Other Pipelines

**Inputs from:**
- `pre-modelling/environmental_data/` → `myExpl_shelf.tif`, `ssp*_shelf_2100.tif`
- `pre-modelling/occurrence_data/` → `occurrences_thinned_0825/*.csv`

**Outputs to:**
- `figures/` → Model predictions and evaluations
- Post-processing analysis → Stacked suitability maps, uncertainty metrics

## Citation

If you use these scripts, please cite:

**Our paper:**
> [Full citation]

**biomod2:**
> Thuiller, W., Georges, D., Gueguen, M., Engler, R., & Breiner, F. (2023). biomod2: Ensemble Platform for Species Distribution Modeling. R package version 4.2-5.

## Contact

**Justine Pagnier**  
University of Gothenburg  
justine.pagnier@gu.se

---

**Note:** File paths and HPC module versions in SLURM scripts are specific to the Dardel cluster at PDC (KTH). Adjust for your HPC environment.
